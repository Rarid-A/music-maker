<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DAW Music Maker - Create music online with virtual instruments">
    <title>DAW Music Maker - Studio</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- DAW Container -->
    <div class="daw-container">
        
        <!-- Top Bar (Header + Transport) -->
        <header class="top-bar" role="banner">
            <div class="logo">
                <h1>🎵 Music Studio</h1>
            </div>
            
            <!-- Transport Controls -->
            <div class="transport-controls" role="toolbar" aria-label="Playback controls">
                <button id="playBtn" class="transport-btn" title="Play/Pause (Space)" aria-label="Play or Pause">
                    <span class="icon" aria-hidden="true">▶️</span>
                </button>
                <button id="stopBtn" class="transport-btn" title="Stop (Esc)" aria-label="Stop playback">
                    <span class="icon" aria-hidden="true">⏹️</span>
                </button>
                
                <div class="tempo-display">
                    <label for="tempoInput">BPM:</label>
                    <input type="number" id="tempoInput" value="120" min="40" max="200" aria-label="Tempo in beats per minute">
                </div>
                
                <div class="tempo-display">
                    <label for="swingInput">Swing:</label>
                    <input type="range" id="swingInput" value="0" min="0" max="66" step="1" aria-label="Swing amount" style="width: 80px;">
                </div>
                
                <div class="beat-display" role="status" aria-live="polite" aria-label="Current beat position">
                    <span id="beatCounter">1.1.1</span>
                </div>
            </div>
            
            <!-- Right Controls -->
            <div class="top-right-controls">
                <select id="presetsDropdown" class="presets-dropdown" aria-label="Load preset pattern">
                    <option value="">📁 Load Preset...</option>
                    <option value="demo">🎵 Demo Beat</option>
                    <option value="techno">🔊 Techno</option>
                    <option value="trap">🎤 Trap</option>
                    <option value="synthwave">🌆 Synthwave</option>
                    <option value="futurebass">🎹 Future Bass</option>
                    <option value="lofi">🎹 Lo-fi Hip Hop</option>
                    <option value="dubstep">💥 Dubstep</option>
                    <option value="house">🏠 House</option>
                    <option value="ambient">🌌 Ambient</option>
                    <option value="dnb">⚡ Drum & Bass</option>
                    <option value="game">⚡ Game Style</option>
                </select>
                <button id="saveProjectBtn" class="btn-export" aria-label="Save project as JSON">💾 Save</button>
                <button id="loadProjectBtn" class="btn-export" aria-label="Load project from JSON">📂 Load</button>
                <button id="exportBtn" class="btn-export" aria-label="Export loop as MP3">🎵 Export</button>
                <button id="exportMidiBtn" class="btn-export" aria-label="Export as MIDI file">🎹 MIDI</button>
                <button id="guideToggle" class="btn-icon" title="Help" aria-label="Show help guide">❓</button>
            </div>
        </header>

        <!-- Main Layout (3 columns) -->
        <main class="main-layout" role="main">
            
            <!-- LEFT PANEL: Channel Rack (Instruments) -->
            <aside class="left-panel" role="complementary" aria-label="Instrument channels">
                <div class="panel-header">
                    <h2>🎹 Channels</h2>
                    <button id="addChannelBtn" class="btn-add" aria-label="Add new instrument channel">+</button>
                </div>
                
                <div class="channels-list" id="channelsList" role="list">
                    <!-- Channels will be added here dynamically -->
                </div>
            </aside>
            
            <!-- CENTER PANEL: Piano Roll / Pattern Editor -->
            <section class="center-panel" aria-label="Pattern sequencer and piano">
                <div class="panel-header">
                    <h2>🎼 Piano Roll</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="togglePianoBtn" class="btn-toggle-piano" title="Toggle Piano Keyboard" aria-label="Show/Hide Piano Keyboard">
                            🎹 Hide Piano
                        </button>
                        <div class="piano-roll-controls">
                            <label for="gridSelect">Grid:</label>
                            <select id="gridSelect" aria-label="Note grid resolution">
                                <option value="16" selected>16th notes (recommended)</option>
                                <option value="8">8th notes</option>
                                <option value="4">4th notes</option>
                            </select>
                            <label for="barsSelect">Bars:</label>
                            <select id="barsSelect" aria-label="Number of bars in pattern">
                                <option value="1" selected>1 bar (16 steps)</option>
                                <option value="2">2 bars</option>
                                <option value="4">4 bars</option>
                                <option value="8">8 bars</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Pattern Sequencer -->
                <div class="pattern-sequencer" id="patternSequencer">
                    <div class="sequencer-info">
                        <div style="color: #888; font-size: 0.85em; margin-bottom: 10px;">
                            Click steps to add notes • Selected channel: <span id="selectedChannelName" style="color: #667eea;">None</span>
                        </div>
                    </div>
                    <div class="sequencer-grid" id="sequencerGrid" role="grid" aria-label="Pattern grid">
                        <!-- Pattern grid will be generated here -->
                    </div>
                </div>
                
                <!-- Live Piano Keyboard -->
                <div class="piano-keyboard">
                    <div class="keyboard-label">
                        🎹 Live Keyboard - Play notes live with your computer keyboard!
                        <div style="font-size: 0.85em; color: #888; margin-top: 5px;">
                            Keys A-K for notes • Z-V for drums • Click or tap piano keys
                        </div>
                    </div>
                    <div class="piano" id="livePiano" role="group" aria-label="Virtual piano keyboard">
                        <div class="white-key" data-note="C4" data-key="a" role="button" tabindex="0" aria-label="C4 - Press A key">C</div>
                        <div class="black-key" data-note="C#4" data-key="w" role="button" tabindex="0" aria-label="C sharp 4 - Press W key"></div>
                        <div class="white-key" data-note="D4" data-key="s" role="button" tabindex="0" aria-label="D4 - Press S key">D</div>
                        <div class="black-key" data-note="D#4" data-key="e" role="button" tabindex="0" aria-label="D sharp 4 - Press E key"></div>
                        <div class="white-key" data-note="E4" data-key="d" role="button" tabindex="0" aria-label="E4 - Press D key">E</div>
                        <div class="white-key" data-note="F4" data-key="f" role="button" tabindex="0" aria-label="F4 - Press F key">F</div>
                        <div class="black-key" data-note="F#4" data-key="t" role="button" tabindex="0" aria-label="F sharp 4 - Press T key"></div>
                        <div class="white-key" data-note="G4" data-key="g" role="button" tabindex="0" aria-label="G4 - Press G key">G</div>
                        <div class="black-key" data-note="G#4" data-key="y" role="button" tabindex="0" aria-label="G sharp 4 - Press Y key"></div>
                        <div class="white-key" data-note="A4" data-key="h" role="button" tabindex="0" aria-label="A4 - Press H key">A</div>
                        <div class="black-key" data-note="A#4" data-key="u" role="button" tabindex="0" aria-label="A sharp 4 - Press U key"></div>
                        <div class="white-key" data-note="B4" data-key="j" role="button" tabindex="0" aria-label="B4 - Press J key">B</div>
                        <div class="white-key" data-note="C5" data-key="k" role="button" tabindex="0" aria-label="C5 - Press K key">C</div>
                    </div>
                </div>
            </section>
            
            <!-- RIGHT PANEL: Mixer -->
            <aside class="right-panel" role="complementary" aria-label="Audio mixer">
                <div class="panel-header">
                    <h2>🎚️ Mixer</h2>
                </div>
                
                <div class="mixer-channels" id="mixerChannels" role="group" aria-label="Channel faders">
                    <!-- Mixer channels will be added here dynamically -->
                </div>
                
                <!-- Master Channel -->
                <div class="mixer-channel master-channel">
                    <div class="channel-name">Master</div>
                    <input type="range" id="masterVolume" class="volume-slider vertical" 
                           min="0" max="1" value="0.7" step="0.01" orient="vertical" 
                           aria-label="Master volume" aria-valuemin="0" aria-valuemax="100" aria-valuenow="70">
                    <div class="volume-label" id="masterVolumeLabel" aria-hidden="true">70%</div>
                </div>
            </aside>
            
        </main>

        <!-- Guide Overlay (hidden by default) -->
        <div id="guideOverlay" class="guide-overlay hidden" role="dialog" aria-labelledby="guideTitle" aria-modal="true">
            <div class="guide-content">
                <button class="close-guide" id="closeGuide" aria-label="Close help guide">✕</button>
                <h2 id="guideTitle">🎵 How to Use Music Studio</h2>
                
                <div class="guide-section">
                    <h3>🎵 Welcome! Here's a quick tutorial:</h3>
                    <p>When you first load the app, you'll see a <strong>demo beat</strong> already playing with 3 channels: Drums, Bass, and Lead. Press <strong>Space</strong> to play it!</p>
                </div>
                
                <div class="guide-section">
                    <h3>1️⃣ Understanding the Interface</h3>
                    <ul>
                        <li><strong>Left Panel</strong> - Your instrument channels (click to select)</li>
                        <li><strong>Center Panel</strong> - Piano roll grid for drawing patterns</li>
                        <li><strong>Right Panel</strong> - Mixer for volume control</li>
                        <li><strong>Bottom</strong> - Live keyboard for playing notes</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>2️⃣ Draw Patterns</h3>
                    <p>Click any channel on the left to select it, then <strong>click squares in the grid</strong> to add notes. Each row is a different note. Click again to remove.</p>
                </div>
                
                <div class="guide-section">
                    <h3>3️⃣ Play Live</h3>
                    <p>Use the <strong>keyboard or piano</strong> at the bottom to play notes live with the selected instrument:</p>
                    <ul>
                        <li><strong>A-K</strong> = White keys (C to C)</li>
                        <li><strong>W, E, T, Y, U</strong> = Black keys (sharps)</li>
                        <li><strong>Z, X, C, V</strong> = Drums (Kick, Snare, HiHat, Clap)</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>4️⃣ Add More Instruments</h3>
                    <p>Click the <strong>+ button</strong> in Channels panel. Choose from:</p>
                    <ul>
                        <li><strong>Basic:</strong> Synth, Bass, Pad, Pluck, Drums</li>
                        <li><strong>Techno/Electronic:</strong> Acid Bass (TB-303 style), FM Synth</li>
                        <li><strong>Jazz/Acoustic:</strong> Electric Piano, Vibraphone, Upright Bass</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>🎛️ Genre Starter Kits</h3>
                    <p><strong>Acid Techno Beat:</strong></p>
                    <ul>
                        <li>Add <strong>Drums</strong> - Create a 4/4 kick pattern</li>
                        <li>Add <strong>Acid Bass</strong> - Draw a squelchy bassline</li>
                        <li>Add <strong>FM Synth</strong> - Add aggressive stabs</li>
                        <li>Keep it minimal and repetitive!</li>
                    </ul>
                    <p><strong>Jazz Loop:</strong></p>
                    <ul>
                        <li>Add <strong>Drums</strong> - Swing pattern with hihat emphasis</li>
                        <li>Add <strong>Upright Bass</strong> - Walking bass line</li>
                        <li>Add <strong>Electric Piano</strong> - Chord voicings</li>
                        <li>Add <strong>Vibraphone</strong> - Melodic phrases</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>5️⃣ Mix Your Track</h3>
                    <p>Use the <strong>mixer panel</strong> on the right to adjust volume and mute channels. The "M" button mutes a channel.</p>
                </div>
                
                <div class="guide-section">
                    <h3>6️⃣ Save & Export</h3>
                    <ul>
                        <li><strong>💾 Save</strong> - Save project as JSON file</li>
                        <li><strong>📂 Load</strong> - Load project from JSON file</li>
                        <li><strong>🎵 Export</strong> - Export loop as MP3 audio</li>
                        <li><strong>🎹 MIDI</strong> - Export as MIDI file for use in other DAWs</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>⌨️ Keyboard Shortcuts</h3>
                    <p><strong>Playback:</strong></p>
                    <ul>
                        <li><strong>Space</strong> - Play/Pause</li>
                        <li><strong>Esc</strong> - Stop</li>
                    </ul>
                    <p><strong>Editing:</strong></p>
                    <ul>
                        <li><strong>Ctrl+C</strong> - Copy pattern from selected channel</li>
                        <li><strong>Ctrl+V</strong> - Paste pattern to selected channel</li>
                        <li><strong>Delete</strong> - Clear pattern for selected channel</li>
                        <li><strong>Ctrl+Z</strong> - Undo</li>
                        <li><strong>Ctrl+Shift+Z / Ctrl+Y</strong> - Redo</li>
                    </ul>
                    <p><strong>Live Performance:</strong></p>
                    <ul>
                        <li><strong>A-K</strong> - Play notes (C to C)</li>
                        <li><strong>W, E, T, Y, U</strong> - Black keys (sharps)</li>
                        <li><strong>Z, X, C, V</strong> - Drum sounds (Kick, Snare, HiHat, Clap)</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>🎛️ Advanced Features</h3>
                    <ul>
                        <li><strong>Swing Control</strong> - Add groove/shuffle to your beats</li>
                        <li><strong>Effects System</strong> - Reverb, delay, and filter built-in</li>
                        <li><strong>21 Instruments</strong> - From synths to drums to Game-style sounds</li>
                        <li><strong>8 Genre Presets</strong> - Instant inspiration for your tracks</li>
                        <li><strong>Copy/Paste Patterns</strong> - Quickly duplicate and modify patterns</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>💡 Tips</h3>
                    <ul>
                        <li>Mute channels in the mixer panel to solo others</li>
                        <li>Adjust grid size for different note lengths</li>
                        <li>Watch the beat counter to stay in sync</li>
                        <li>Recording captures all unmuted channels</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Instrument Selection Dialog -->
        <div id="instrumentDialog" class="instrument-dialog hidden" role="dialog" aria-labelledby="instrumentDialogTitle" aria-modal="true">
            <div class="instrument-dialog-content">
                <h3 id="instrumentDialogTitle">🎹 Choose Instrument Type</h3>
                
                <div class="instrument-category">
                    <h4>BASIC INSTRUMENTS</h4>
                    <select id="instrumentSelect" class="instrument-select" size="5">
                        <option value="1">Synth (Lead/Melody)</option>
                        <option value="2">Bass (Deep sound)</option>
                        <option value="3">Pad (Ambient)</option>
                        <option value="4">Pluck (Guitar-like)</option>
                        <option value="5">Drums (Percussion)</option>
                    </select>
                </div>

                <div class="instrument-category">
                    <h4>TECHNO/ELECTRONIC</h4>
                    <select id="instrumentSelectTechno" class="instrument-select" size="5">
                        <option value="6">Acid Bass (TB-303 style)</option>
                        <option value="7">FM Synth (Aggressive leads)</option>
                        <option value="19">Supersaw (EDM/Trance lead)</option>
                        <option value="20">Reese Bass (DnB bass)</option>
                        <option value="21">Wobble Bass (Dubstep bass)</option>
                    </select>
                </div>

                <div class="instrument-category">
                    <h4>JAZZ/ACOUSTIC</h4>
                    <select id="instrumentSelectJazz" class="instrument-select" size="3">
                        <option value="8">Electric Piano</option>
                        <option value="9">Vibraphone</option>
                        <option value="10">Upright Bass</option>
                    </select>
                </div>

                <div class="instrument-category">
                    <h4>GAME/RETRO</h4>
                    <select id="instrumentSelectRetro" class="instrument-select" size="8">
                        <option value="11">Square Wave (Chiptune lead)</option>
                        <option value="12">PWM Bass (Warm bass)</option>
                        <option value="13">Bell (Bright melody)</option>
                        <option value="14">Strings (Orchestral pad)</option>
                        <option value="15">Brass (Punchy brass)</option>
                        <option value="16">Pizzicato (Plucked strings)</option>
                        <option value="17">Marimba (Wooden percussion)</option>
                        <option value="18">Flute (Soft airy)</option>
                    </select>
                </div>

                <div class="instrument-dialog-buttons">
                    <button id="instrumentDialogOk" class="dialog-btn dialog-btn-primary">Add Channel</button>
                    <button id="instrumentDialogCancel" class="dialog-btn dialog-btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Tone.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <!-- Lame.js for MP3 encoding -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.0/lame.min.js"></script>
    
    <!-- Application Modules -->
    <script src="js/audio.js"></script>
    <script src="js/effects.js"></script>
    <script src="js/project.js"></script>
    <script src="js/channels.js"></script>
    <script src="js/sequencer.js"></script>
    <script src="js/presets.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/export.js"></script>
    <script src="app.js"></script>
</body>
</html>
